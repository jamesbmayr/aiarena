<!DOCTYPE html>
<html>
	<head>
		<title>ai_arenas.<% try {data.id.substring(0,4)} catch(error) {"arenas"} %></title>
		<% assets("meta") %>
		<link rel="shortcut icon" type="image/png" href="logo.png"/>
		<link rel="stylesheet" type="text/css" href="<% assets('bootstrap') %>"/>
		<link rel="stylesheet" type="text/css" href="<% assets('google_fonts') %>"/>
		<link rel="stylesheet" type="text/css" href="../../arenas/stylesheet.css"/>
		<% colors(session) + fonts(session); %>
		<script type="text/javascript" src="<% assets('jquery') %>"></script>
		<script type="text/javascript" src="../../arenas/script.js"></script>
	</head>
	<body>
		<% navbar(session, "/arenas/" + data.id.substring(0,4)); %>
		<% 
			// timeNow
				var timeNow = new Date().getTime();

			// state
				if ((data.state.start === null) || (data.state.start - 5000 > timeNow)) {
					var state = 'unstarted';
				}
				else if ((data.state.end !== null) && (data.state.end < timeNow)) {
					var state = 'concluded';
				}
				else {
					var state = 'active';
				}

			// paused
				if ((data.state.pauseFrom !== null) && (data.state.pauseTo !== null) && (data.state.pauseFrom < timeNow) && (data.state.pauseTo > timeNow)) {
					var paused = true;
				}
				else {
					var paused = false;
				}

			// participating
				if ((session.human !== null) && (data.humans.indexOf(session.human.id) > -1)) {
					var participating = true;
				} 
				else if (data.humans.indexOf("session_" + session.id) > -1) {
					var participating = true;
				}
				else {
					var participating = false;
				}

			// self_entrant
				if (Object.keys(data.entrants).length > 0) {
					if (session.human !== null) {
						var self_entrant = data.entrants[Object.keys(data.entrants).find(function(i) { return data.entrants[i].human.id === session.human.id })] || null;
					}
					else {
						var self_entrant = data.entrants[Object.keys(data.entrants).find(function(i) { return data.entrants[i].human.id === "session_" + session.id })] || null;
					}
				}
				else {
					var self_entrant = null;
				}
		%>
		<div class="container" value="<% data.id || null %>">
			<div class="top_outer">
				<div class="top_inner">
					<span class="glyphicon glyphicon-chevron-down section-toggle section-toggle-down whitetext"></span>
					<div class="section bracketer_top">
						<span class="whitetext header"><% try {data.id.substring(0,4)} catch(error) {"arenas"} %></span> <span class="graytext" id="message_top"></span>
					</div>
					<div class="indented">
						<div class="section" <% if (state !== "active") { "style='display: none;'";} %>>
							<span class="whitetext">.round</span><span class="redtext"> = </span><span id="round" class="purpletext" value="<% state %>"><%
								if (state !== "active") {
									"null";
								}
								else {
									var pastRounds = data.rounds.filter(function(round) { var now = new Date().getTime(); return (round.start <= now);});

									if (pastRounds.length > 0) {
										Number(pastRounds.length - 1);
									}
									else {
										"null";
									}
								}
							%></span>
						</div>
						<div class="section" id="pauseDetails" <% if ((state !== "active") || (!paused)) { "style='display: none;'";} %>>
							<span class="whitetext">.workshopRemaining</span><span class="redtext"> = </span><span id="pause" class="purpletext"><% 
								if ((state === "active") && (paused)) {
									Math.floor((data.state.pauseTo - (new Date().getTime())) / 1000);
								}
								else {
									"null";
								}
							%></span>
						</div>
						<% 
							if ((state === "unstarted") && (participating)) {
								var string = "";								
								if (self_entrant === null) {
									var options = "";
									
									if (session.human !== null) {
										var values = session.human.robots || [];
										for (var i = 0; i < values.length; i++) {
											options += '<option value="' + values[i].id + '">' + values[i].name + '</option>';
										}
									}

									string += '<form id="selection_form" method="post" action="javascript:;" onsubmit="window.select_robot();">\
										<span class="whitetext">.</span><button id="select_robot" name="action" value="select_robot"><span class="greentext">select</span></button><span class="whitetext">(</span><span class="select_outer orangetext"><select class="orangetext" id="robot_selection">' + options + '<option value="upload">upload</option></select></span><span class="whitetext">)</span>\
										</form>\
										<div class="section">\
											<input type="file" name="file_chooser" id="file_chooser"/>\
										</div>';
								}

								if ((session.human !== null) && (data.humans[0] === session.human.id)) {
									//aiBots
										var allBots = [];
										for (entrant of Object.keys(data.entrants)) {
											allBots.push(data.entrants[entrant].name);
										}

										var aiBots = assets("aibots").filter(function(x) {
											return allBots.indexOf(x) === -1;
										});
										var options = "";
										for (aiBot of aiBots) {
											options += '<option value="' + aiBot + '">' + aiBot + '</option>';
										}

									string += '<form id="addaibot_form" method="post" action="javascript:;" onsubmit="window.add_aibot();">\
										<span class="whitetext">.</span><button id="add_aibot" name="action" value="add_aibot"><span class="greentext">add_aiBot</span></button><span class="whitetext">(<span class="select_outer orangetext"><select class="orangetext" id="aibot_selection">' + options + '</select></span>)</span>\
									</form>';

									string += '<form id="launch_form" method="post" action="javascript:;" onsubmit="window.launch_arena();">\
										<span class="whitetext">.</span><button id="launch_arena" name="action" value="launch_arena"><span class="greentext">launch</span></button><span class="whitetext">()</span>\
									</form>';

									string += '<form id="delete_form" method="post" action="javascript:;" onsubmit="window.delete_arena();">\
										<span class="whitetext">.</span><button id="delete_arena" name="action" value="delete_arena"><span class="greentext">delete</span></button><span class="whitetext">()</span>\
									</form>';
								}

								string += '<form id="leave_form" method="post" action="javascript:;" onsubmit="window.leave_arena();">\
									<span class="whitetext">.</span><button id="leave_arena" name="action" value="leave_arena"><span class="greentext">leave</span></button><span class="whitetext">()</span>\
								</form>';

								string;
							}
							else if (state === "unstarted") {
								'<form id="join_form" method="post" action="javascript:;" onsubmit="window.join_arena();">\
									<span class="whitetext">.</span><button id="join_arena" name="action" value="join_arena"><span class="greentext">join</span></button><span class="whitetext">()</span>\
								</form>';
							}
						%>
						<div class="section" id="victors" <% if (state !== "concluded") {"style='display: none';"} %>>
							<span class="whitetext">.victors</span><span class="redtext"> = </span><span class="whitetext">[</span>
							<span class="victorList whitetext">
								<% 
									if (state === "concluded") {
										var victors = data.state.victors;
										var string = "";

										for (var i = 0; i < victors.length; i++) {
											if (data.entrants[victors[i]].human.name === "guest") {
												string += "{<span class='victor'><span class='victor_human bluetext'>" + data.entrants[victors[i]].human.name + "</span>: <span class='victor_robot bluetext'>" + data.entrants[victors[i]].name + "</span></span>}, ";
											}
											else {
												string += "{<span class='victor'><a class='victor_human bluetext' href='../../../../humans/" + data.entrants[victors[i]].human.name + "'>" + data.entrants[victors[i]].human.name + "</a>: <a class='victor_robot bluetext' href='../../../../robots/" + victors[i] + "'>" + data.entrants[victors[i]].name + "</a></span>}, ";
											}
										}

										string.substring(0, string.length - 2);
									}
								%>
							</span>
						<span class="whitetext">]</span>
					</div>
					</div>
					<hr>
				</div>
			</div>
			<div class="indented content">
				<div class="megasection" id="postgame_outer" <% if (state !== "concluded") {"style='display: none';"} %>>
					<div class="section" id="postgame">
						<%
							if (state === "concluded") {
								if (participating) {
									var victory = false;
									for (var i = 0; i < data.state.victors.length; i++) {
										if (data.state.victors[i] === self_entrant.id) {
											victory = true;
										}
									}

									if (victory) {
											'<span class="graytext message spectatorMessage">//your robot has achieved victory in this arena</span>';
									}
									else {
										'<span class="graytext message spectatorMessage">//your robot has achieved defeat in this arena</span>';
									}
								}
								else {
									'<span class="graytext message spectatorMessage">//this arena has concluded</span>';
								}
							}
						%>
					</div>
				</div>
				<div class="megasection" id="players_outer" <% if (state !== "unstarted") {"style='display: none';"} %>>
					<span class="glyphicon glyphicon-chevron-down section-toggle section-toggle-down whitetext"></span>
					<div class="bracketer_top"><span class="whitetext">.players</span><span class="redtext"> = </span><span class="whitetext">[</span></div>
					<div class="section indented whitetext" id="players" value="<% data.humans %>">
						<% 
							var string = "";
							for (var i = 0; i < data.humans.length; i++) {
								if (data.humans[i] !== 0) {
									var entrant = data.entrants[Object.keys(data.entrants).find(function(j) { return (data.entrants[j].human.id === data.humans[i])})];
									if ((typeof entrant !== "undefined") && (entrant !== "undefined") && (entrant !== null)) {
										if (entrant.human.name === "guest") {
											string += "<span class='bluetext player'>guest</a>, ";
										}
										else {
											string += "<a class='bluetext player' target='_blank' href='../../../../humans/" + entrant.human.name + "'>" + entrant.human.name + "</a>, ";
										}
									}
									else {
										string += "<span class='yellowtext unknown player'>???</span>, ";
									}
								}
							}

							string.substring(0, string.length - 2);
						%>
					</div>
					<div class="bracketer_bottom"><span class="whitetext">]</span></div>
				</div>
				<div class="megasection" id="workshop_outer" <% if (state !== "active") { "style='display: none';"; } %>>
					<span class="glyphicon glyphicon-chevron-down section-toggle section-toggle-down whitetext"></span>
					<div class="bracketer_top"><span class="whitetext">.code</span><span class="redtext"> = </span><span class="whitetext">{</span></div>
					<div class="section" id="workshop" value="<% try { self_entrant.id } catch(error) { null } %>"><%
						if (state === "active") {
							// workshop_options
								var workshop_options = "";
								for (entrant in data.entrants) {
									if ((self_entrant) && (entrant === self_entrant.id)) {
										workshop_options += "<option selected value='" + entrant + "'>" + data.entrants[entrant].name + "</option>";
									}
									else {
										workshop_options += "<option value='" + entrant + "'>" + data.entrants[entrant].name + "</option>";
									}
								}

							// inputList
								if ((session.human !== null) && (session.human.tutorials.indexOf("deriveBot") !== -1)) {
									var inputList = '<li><span class="orangetext">arena</span>: all information</li>\
									<li><span class="orangetext">name</span>: name of this robot <details><summary></summary><span class="code">arguments.callee.name</span></details></li>\
									<li><span class="orangetext">rules</span>: arena parameters <details><summary></summary><span class="code">arena.rules</span></details></li>\
									<li><span class="orangetext">rounds</span>: all previous rounds <details><summary></summary><span class="code">arena.rounds</span></details></li>\
									<li><span class="orangetext">roundCount</span>: number of rounds <details><summary></summary><span class="code">arena.rounds.length - 1</span></details></li>\
									<li><span class="orangetext">currentRound</span>: all data of the round that just executed <details><summary></summary><span class="code">arena.rounds[arena.rounds.length - 1]</span></details></li>\
									<li><span class="orangetext">lastRound</span>: all data of the previous round <details><summary></summary><span class="code">arena.rounds[arena.rounds.length - 2]</span></details></li>\
									<li><span class="orangetext">firstRound</span>: all data from the starting round <details><summary></summary><span class="code">arena.rounds[0]</span></details></li>\
									<li><span class="orangetext">robots</span>: currentRound data of all robots <details><summary></summary><span class="code">arena.rounds[arena.rounds.length - 1].robots</span></details></li>\
									<li><span class="orangetext">robotCount</span>: number of robots in the arena <details><summary></summary><span class="code">arena.rounds[arena.rounds.length - 1].robots.length</span></details></li>\
									<li><span class="orangetext">allCubes</span>: all cubes in the currentRound <details><summary></summary><span class="code">arena.rounds[arena.rounds.length - 1].cubes</span></details></li>\
									<li><span class="orangetext">newCubes</span>: all cubes spawned for the currentRound <details><summary></summary><span class="code">arena.rounds[arena.rounds.length - 1].cubes.slice(-arena.rules.cubes.spawnRate)</span></details></li>\
									<li><span class="orangetext">self</span>: currentRound data of the robot executing this code <details><summary></summary><span class="code">name = arguments.callee.name; arena.rounds[arena.rounds.length - 1].robots.find(function(robot) {return robot.name === name})</span></details></li>\
									<li><span class="orangetext">power</span>: power of self in the currentRound <details><summary></summary><span class="code">name = arguments.callee.name; arena.rounds[arena.rounds.length - 1].robots.find(function(robot) {return robot.name === name}).power</span></details></li>\
									<li><span class="orangetext">cubes</span>: cubes owned by self in the currentRound <details><summary></summary><span class="code">name = arguments.callee.name; arena.rounds[arena.rounds.length - 1].robots.find(function(robot) {return robot.name === name}).cubes</span></details></li>\
									<li><span class="orangetext">action</span>: action performed by self in the currentRound <details><summary></summary><span class="code">name = arguments.callee.name; arena.rounds[arena.rounds.length - 1].robots.find(function(robot) {return robot.name === name}).action</span></details></li>\
									<li><span class="orangetext">winner</span>: name of robot that won the currentRound <details><summary></summary><span class="code">arena.rounds[arena.rounds.length - 1].winner</span></details></li>\
									<li><span class="orangetext">opponents</span>: currentRound data of all robots except self <details><summary></summary><span class="code">name = arguments.callee.name; arena.rounds[arena.rounds.length - 1].robots.filter(function(robot) {return robot.name !== name})</span></details></li>\
									<li><span class="orangetext">colors</span>: list of cube colors <details><summary></summary><span class="code">arena.rules.cubes.colors</span></details></li>\
									<li><span class="orangetext">actions</span>: list of robot actions <details><summary></summary><span class="code">arena.rules.robots.actions</span></details></li>\
									<li><span class="orangetext">conditions</span>: list of victory conditions <details><summary></summary><span class="code">arena.rules.victory.conditions</span></details></li>';
								}
								else {
									var inputList = '<li><span class="orangetext">arena</span>: all information</li>\
									<li><span class="orangetext">name</span>: name of this robot</li>\
									<li><span class="orangetext">rules</span>: arena parameters</li>\
									<li><span class="orangetext">rounds</span>: all previous rounds</li>\
									<li><span class="orangetext">roundCount</span>: number of rounds</li>\
									<li><span class="orangetext">currentRound</span>: all data of the round that just executed</li>\
									<li><span class="orangetext">lastRound</span>: all data of the previous round</li>\
									<li><span class="orangetext">firstRound</span>: all data from the starting round</li>\
									<li><span class="orangetext">robots</span>: currentRound data of all robots</li>\
									<li><span class="orangetext">robotCount</span>: number of robots in the arena</li>\
									<li><span class="orangetext">allCubes</span>: all cubes in the currentRound</li>\
									<li><span class="orangetext">newCubes</span>: all cubes spawned for the currentRound</li>\
									<li><span class="orangetext">self</span>: currentRound data of the robot executing this code</li>\
									<li><span class="orangetext">power</span>: power of self in the currentRound</li>\
									<li><span class="orangetext">cubes</span>: cubes owned by self in the currentRound</li>\
									<li><span class="orangetext">action</span>: action performed by self in the currentRound</li>\
									<li><span class="orangetext">winner</span>: name of robot that won the currentRound</li>\
									<li><span class="orangetext">opponents</span>: currentRound data of all robots except self</li>\
									<li><span class="orangetext">colors</span>: list of cube colors</li>\
									<li><span class="orangetext">actions</span>: list of robot actions</li>\
									<li><span class="orangetext">conditions</span>: list of victory conditions</li>';
								}

							// outputList
								var outputList = '<li><span class="greentext">power</span>: increment the robot\'s power number</li>\
									<li><span class="greentext">take</span>: the taker with the most power wins the round\'s cubes</li>\
									<li><span class="greentext">sleep</span>: do nothing; this is the default for code errors or taking without power</li>';
								if ((session.human !== null) && (session.human.email !== null) && (((session.human.statistics.wins * 5) + session.human.statistics.losses) >= 25)) {
									outputList += '<li><span class="greentext">sap</span>: steal power from charging opponents with greater power</li>\
									<li><span class="greentext">halftake</span>: use half power, rounding up, to take cubes</li>\
									<li><span class="greentext">fliptake</span>: take the cubes but invert the colors</li>';
								}
								if ((session.human !== null) && (session.human.email !== null) && (((session.human.statistics.wins * 5) + session.human.statistics.losses) >= 50)) {
									outputList += '<li><span class="greentext">burn</span>: convert a random cube into power</li>\
									<li><span class="greentext">shock</span>: use half power to put opponents with more total cubes to sleep</li>\
									<li><span class="greentext">swaptake</span>: use half power to take cubes and return the same number of cubes, randomly</li>';
								}

							// save_form, inputs, code
								if (self_entrant) {
									var save_form = '<div class="section indented">\
										<form id="save_form" method="post" action="javascript:;" onsubmit="window.robot_save();" ' + (paused ? '' : 'style="display: none;"') + '>\
												<button id="robot_save"><span class="greentext">save</span><span class="whitetext">: </span><span class="bluetext">function</span><span class="whitetext">()</span></button>\
											</form>\
									</div> <span class="message graytext"></span>';

									var code_outer = '<div class="section indented" id="code_outer">';

									var inputs = '<span class="field_frame' + (paused ? ' active' : '') + '"><span class="orangetext field" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"' + (paused ? ' contenteditable="true"' : '') + ' id="inputs" value=' + (String(self_entrant.inputs.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;")).replace(/\</g, "&lt;").replace(/\>/g, "&gt;") || null) + '>' + String(self_entrant.inputs) + '</span></span><span class="whitetext">) {</span> <span class="message graytext"></span>';

									var code = '<div class="field_frame' + (paused ? ' active' : '') + '">\
										<span class="whitetext field" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"' + (paused ? ' contenteditable="true"' : '') + ' id="code" value=' + (String(self_entrant.code.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;").replace(/\</g, "&lt;").replace(/\>/g, "&gt;")) || null) + '>' + String(self_entrant.code) + '</span>\
									</div>';

									var spectatorWorkshop = '';

									var outputs = '<div class="section indented"' + (paused ? ' style="display: none;"' : '') + '>\
										<span class="whitetext">output: </span><span id="output" class="yellowtext"></span>\
										<br>\
										<details class="graytext" open><summary>//console</summary><div id="console"></div></details>\
									</div>';
								}
								else {
									var save_form = "";

									var code_outer = '<div class="section indented" id="code_outer" ' + (paused ? ' style="display: none;"' : '') + '>';

									var inputs = '<span class="field_frame"><span class="orangetext field" id="inputs" value=""></span></span><span class="whitetext">) {</span>';

									var code = '<div class="field_frame"><span class="whitetext field" id="code"></span></div>';

									var spectatorWorkshop = '<div class="section indented graytext" id="spectator_workshop" ' + (paused ? "" : ' style="display: none;"') + '>//arena paused</div>';

									var outputs = '<div class="section indented"' + (paused ? ' style="display: none;"' : '') + '>\
										<span class="whitetext">output: </span><span id="output" class="yellowtext"></span>\
									</div>';
								}

							// workshop
								save_form + code_outer +
									'<span class="select_outer greentext"><select class="greentext" id="workshop_select"' + (paused ? "disabled" : "") + '>' + workshop_options + '</select></span><span class="whitetext">: </span><span class="bluetext">function</span><span class="whitetext">(</span>' + inputs + ' <span class="graytext"> // <details class="graytext"><summary><span>inputs:</span></summary><span><ul>' + inputList + '</ul></span></details></span>\
									<div class="indented">' + code + '</div>\
									<span class="whitetext">}</span>\
									<span class="graytext"> // <details class="graytext"><summary><span>outputs:</span></summary><ul>' + outputList + '</ul></details></span>\
								</div>' + spectatorWorkshop + outputs;
						}
					%></div>
					<div class="bracketer_bottom"><span class="whitetext">}</span></div>
				</div>
				<span class="glyphicon glyphicon-chevron-down section-toggle section-toggle-down whitetext"></span>
				<div class="bracketer_top"><span class="whitetext">.robots</span><span class="redtext"> = </span><span class="whitetext">[</span></div>
				<div class="megasection" id="robots" value="<% Object.keys(data.entrants) %>">
					<div class="section indented">
						<%  
							if ((data.entrants !== null) && (Object.keys(data.entrants).length > 0)) {
								var string = "";
								
								if (self_entrant !== null) {
									var entrants = Object.keys(data.entrants).filter(function(i) { return data.entrants[i].id !== self_entrant.id }) || [];
									entrants.unshift(Object.keys(data.entrants).find(function (i) { return data.entrants[i].id === self_entrant.id }));
								}
								else {
									var entrants = Object.keys(data.entrants);
								}

								for (var i = 0; i < entrants.length; i++) {
									var entrant = data.entrants[entrants[i]];
									if (data.rounds.length > 0) {
										var robot = data.rounds[data.rounds.length - 1].robots.find(function(i) { return i.name === entrant.id}) || {};
									}
									else {
										var robot = {
											power: 0,
											cubes: {
												red: 0,
												orange: 0,
												yellow: 0,
												green: 0,
												blue: 0,
												purple: 0
											}
										};
									}

									if (entrant.human.name === "guest") {
										var robot_link = '<span class="bluetext avatar_name">' + entrant.name + '</span>';
									}
									else {
										var robot_link = '<a class="bluetext avatar_name" href="../../../../robots/' + entrant.id + '" target="_blank">' + entrant.name + '</a>';
									}

									if (state === "concluded") {
										if (data.state.victors.indexOf(entrant.id) !== -1) {
											var robot_victory = " win";
										}
										else {
											var robot_victory = " loss";
										}
									}
									else {
										robot_victory = "";
									}

									string += ('<div class="section opponent' + robot_victory + '" id="' + entrant.id + '">'
										+ robot_link +
										'<div class="stats">\
											<span class="whitetext">power:</span><span class="purpletext power count">' + (robot.power || "0") + '</span><br>\
											<div class="whitetext">\
												cubes.<span class="redtext">red</span>:<span class="cubes_red count purpletext">' + (robot.cubes.red || "0") + '</span><br>\
												cubes.<span class="orangetext">orange</span>:<span class="cubes_orange count purpletext">' + (robot.cubes.orange || "0") + '</span><br>\
												cubes.<span class="yellowtext">yellow</span>:<span class="cubes_yellow count purpletext">' + (robot.cubes.yellow || "0") + '</span><br>\
												cubes.<span class="greentext">green</span>:<span class="cubes_green count purpletext">' + (robot.cubes.green || "0") + '</span><br>\
												cubes.<span class="bluetext">blue</span>:<span class="cubes_blue count purpletext">' + (robot.cubes.blue || "0") + '</span><br>\
												cubes.<span class="purpletext">purple</span>:<span class="cubes_purple count purpletext">' + (robot.cubes.purple || "0") + '</span>\
											</div>\
											<span class="whitetext">action: </span><span class="yellowtext action count">' + (robot.action || "?") + '</span>\
										</div>\
										<pre class="avatar_pre" monospace style="color: ' + (entrant.avatar.color || "var(--white)") + '">\
<span class="transparenttext leftDot">•</span><span class="transparenttext">•••••</span><span class="avatar avatar_antennae" value="' + (entrant.avatar.antennae.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '•••••') + '">' + (entrant.avatar.antennae || "•••••") + '</span><span class="transparenttext">•••••</span>\n\
<span class="transparenttext leftDot">•</span><span class="avatar avatar_left_hand" value="' + (entrant.avatar.left_hand.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '••••') + '">' + (entrant.avatar.left_hand || "••••") + '</span><span class="transparenttext">•</span><span class="avatar avatar_eyes" value="' + (entrant.avatar.eyes.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '•••••') + '">' + (entrant.avatar.eyes || "•••••") + '</span><span class="transparenttext">•</span><span class="avatar avatar_right_hand transparenttext" value="' + (entrant.avatar.right_hand.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '••••') + '">' + (entrant.avatar.right_hand || "••••") + '</span>\n\
<span class="transparenttext leftDot">•</span><span class="avatar avatar_left_wrist" value="' + (entrant.avatar.left_wrist.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '••••') + '">' + (entrant.avatar.left_wrist || "••••") + '</span><span class="transparenttext">•</span><span class="avatar avatar_mouth" value="' + (entrant.avatar.mouth.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '•••••') + '">' + (entrant.avatar.mouth || "•••••") + '</span><span class="transparenttext">•</span><span class="avatar avatar_right_wrist transparenttext" value="' + (entrant.avatar.right_wrist.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '••') + '">' + (entrant.avatar.right_wrist || "••") + '</span>\n\
<span class="transparenttext leftDot">•</span><span class="transparenttext">••</span><span class="avatar avatar_left_shoulder_up">\\</span><span class="avatar avatar_left_shoulder_down" style="display: none">/</span><span class="avatar avatar_left_arm" value="' + (entrant.avatar.left_arm.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '••') + '">' + (entrant.avatar.left_arm || "••") + '</span><span class="avatar avatar_torso_1" value="' + (entrant.avatar.torso_1.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '•••••') + '">' + (entrant.avatar.torso_1 || "•••••") + '</span><span class="avatar avatar_right_arm" value="' + (entrant.avatar.right_arm.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '••') + '">' + (entrant.avatar.right_arm || "••") + '</span><span class="avatar avatar_right_shoulder_up" style="display: none">/</span><span class="avatar avatar_right_shoulder_down">\\</span><span class="transparenttext">••</span>\n\
<span class="transparenttext leftDot">•</span><span class="avatar avatar_left_wrist transparenttext" value="' + (entrant.avatar.left_wrist.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '••••') + '">' + (entrant.avatar.left_wrist || "••••") + '</span><span class="transparenttext">•</span><span class="avatar avatar_torso_2" value="' + (entrant.avatar.torso_2.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '•••••') + '">' + (entrant.avatar.torso_2 || "•••••") + '</span><span class="transparenttext">•</span><span class="avatar avatar_right_wrist" value="' + (entrant.avatar.right_wrist.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '••') + '">' + (entrant.avatar.right_wrist || "••") + '</span>\n\
<span class="transparenttext leftDot">•</span><span class="avatar avatar_left_hand transparenttext" value="' + (entrant.avatar.left_hand.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '••••') + '">' + (entrant.avatar.left_hand || "••••") + '</span><span class="transparenttext">•</span><span class="avatar avatar_torso_3" value="' + (entrant.avatar.torso_3.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '•••••') + '">' + (entrant.avatar.torso_3 || "•••••") + '</span><span class="transparenttext">•</span><span class="avatar avatar_right_hand" value="' + (entrant.avatar.right_hand.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '••••') + '">' + (entrant.avatar.right_hand || "••••") + '</span>\n\
<span class="transparenttext leftDot">•</span><span class="transparenttext">••••</span><span class="avatar avatar_left_leg" value="' + (entrant.avatar.left_leg.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '•••') + '">' + (entrant.avatar.left_leg || "•••") + '</span><span class="transparenttext">•</span><span class="avatar avatar_right_leg" value="' + (entrant.avatar.right_leg.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '•••') + '">' + (entrant.avatar.right_leg || "•••") + '</span><span class="transparenttext">••••</span>\n\
<span class="transparenttext leftDot">•</span><span class="transparenttext">••••</span><span class="avatar avatar_left_foot" value="' + (entrant.avatar.left_foot.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '•••') + '">' + (entrant.avatar.left_foot || "•••") + '</span><span class="transparenttext">•</span><span class="avatar avatar_right_foot" value="' + (entrant.avatar.right_foot.replace(/\"/g, "&#34;").replace(/\'/g, "&#39;") || '•••') + '">' + (entrant.avatar.right_foot || "•••") + '</span><span class="transparenttext">••••</span></pre>\
									</div>');
								}

								if (participating) {
									string.replace("section opponent", "section self"); //replaces only the first one
								}
								else {
									string;
								}
							}
						%>
					</div>
				</div>
				<div class="bracketer_bottom"><span class="whitetext">]</span></div>
				<div class="megasection" id="cubes_outer" <% if (state !== "active") {"style='display: none';"} %>>
					<span class="glyphicon glyphicon-chevron-down section-toggle section-toggle-down whitetext"></span>
					<div class="bracketer_top"><span class="whitetext">.cubes</span><span class="redtext"> = </span><span class="whitetext">[</span></div>
					<div class="section indented whitetext" id="cubes">
						<div id="cube_spacer"></div>
						<% 
							if ((state === "active") && (pastRounds.length > 0)) {
								var currentRound = pastRounds[pastRounds.length - 1];
								var string = "";

								for (var i = 0; i < currentRound.cubes.length; i++) {
									string += "<div class='cube_outer " + currentRound.cubes[i] + "back'><div class='cube_inner whitetext'>" + currentRound.cubes[i] + "</div></div>";
								}

								string;
							}
						%>
					</div>
					<div class="bracketer_bottom"><span class="whitetext">]</span></div>
				</div>
				<span class="glyphicon glyphicon-chevron-up section-toggle section-toggle-up whitetext"></span>
				<div class="bracketer_top"><span class="whitetext">.rules</span><span class="redtext"> = </span><span class="whitetext">{</span></div>
				<div class="megasection indented" id="rules" style="display: none;">
					<div class="section" id="rules_players">
						<span class="whitetext">players: {</span>
						<div class="indented">
							<span class="whitetext">minimum: </span><span class="purpletext"><% String(data.rules.players.minimum) || "null" %></span><span class="whitetext">,</span><span class="graytext"> // <details class="graytext"><summary><span>how many humans must this arena contain at least?</span></summary></details></span><br>
							<span class="whitetext">maximum: </span><span class="purpletext"><% String(data.rules.players.maximum) || "null" %></span><span class="whitetext">,</span><span class="graytext"> // <details class="graytext"><summary><span>how many humans can this arena contain at most?</span></summary></details></span><br>
							<span class="whitetext">workshopDuration: </span><span class="purpletext"><% ((data.rules.players.workshopDuration / 1000 / 60) + ":00") || "null" %></span><span class="whitetext">,</span><span class="graytext"> // <details class="graytext"><summary><span>how long does the code workshop last?</span></summary></details></span><br>
							<span class="whitetext">workshopPeriod: </span><span class="purpletext"><% String(data.rules.players.workshopPeriod) || "null" %></span><span class="graytext"> // <details class="graytext"><summary><span>how many rounds occur between each code workshop?</span></summary></details></span>
						</div>
						<span class="whitetext">},</span>
					</div>
					<div class="section" id="rules_cubes">
						<span class="whitetext">cubes: {</span>
						<div class="indented">
							<span class="whitetext">colors: [</span><span class="whitetext"><% 
								try {
									var string = "";
									for (var i = 0; i < data.rules.cubes.colors.length; i++) {
										string += ("<span class='" + data.rules.cubes.colors[i] + "text'>" + data.rules.cubes.colors[i] + "</span>, ");
									}
									string.substring(0, string.length - 2);
								}
								catch (error) {
									"null";
								}
							%></span><span class="whitetext">],</span><span class="graytext"> // <details class="graytext"><summary><span>which cube colors does this arena include?</span></summary></details></span><br>
							<span class="whitetext">startCount: </span><span class="purpletext"><% String(data.rules.cubes.startCount) || "null" %></span><span class="whitetext">,</span><span class="graytext"> // <details class="graytext"><summary><span>how many cubes does each robot start with?</span></summary></details></span><br>
							<span class="whitetext">maximum: </span><span class="purpletext"><% String(data.rules.cubes.maximum) || "null" %></span><span class="whitetext">,</span><span class="graytext"> // <details class="graytext"><summary><span>how many cubes can a robot hold?</span></summary></details></span><br>
							<span class="whitetext">spawnRate: </span><span class="purpletext"><% String(data.rules.cubes.spawnRate) || "null" %></span><span class="whitetext">,</span><span class="graytext"> // <details class="graytext"><summary><span>how many cubes are generated each round?</span></summary></details></span><br>
							<span class="whitetext">spawnMemory: </span><span class="purpletext"><% String(data.rules.cubes.spawnMemory) || "null" %></span><span class="whitetext">,</span><span class="graytext"> // <details class="graytext"><summary><span>when a cube spawns, how many rounds must pass until a cube of the same color can spawn?</span></summary></details></span><br>
							<span class="whitetext">dissolveRate: </span><span class="purpletext"><% String(data.rules.cubes.dissolveRate) || "null" %></span><span class="whitetext">,</span><span class="graytext"> // <details class="graytext"><summary><span>how many untaken cubes are destroyed each round?</span></summary></details></span><br>
							<span class="whitetext">dissolveIndex: </span><span class="yellowtext">"<% data.rules.cubes.dissolveIndex || "null" %>"</span><span class="graytext"> // <details class="graytext"><summary><span>which cubes are destroyed each round?</span></summary></details></span>
						</div>
						<span class="whitetext">},</span>
					</div>
					<div class="section" id="rules_robots">
						<span class="whitetext">robots: {</span>
						<div class="indented">
							<span class="whitetext">startPower: </span><span class="purpletext"><% String(data.rules.robots.startPower) || "null" %></span><span class="whitetext">,</span><span class="graytext"> // <details class="graytext"><summary><span>how much power does each robot enter the arena with?</span></summary></details></span><br>
							<span class="whitetext">maxPower: </span><span class="purpletext"><% String(data.rules.robots.maxPower) || "null" %></span><span class="whitetext">,</span><span class="graytext"> // <details class="graytext"><summary><span>how much power can a robot hold?</span></summary></details></span><br>
							<span class="whitetext">powerRate: </span><span class="purpletext"><% String(data.rules.robots.powerRate) || "null" %></span><span class="whitetext">,</span><span class="graytext"> // <details class="graytext"><summary><span>when a robot powers, how much does its power increase?</span></summary></details></span><br>
							<span class="whitetext">actions: [</span><span class="whitetext"><% 
								try {
									var string = "";
									for (var i = 0; i < data.rules.robots.actions.length; i++) {
										string += ("<span class='greentext'>" + data.rules.robots.actions[i] + "</span>(), ");
									}
									string.substring(0, string.length - 2);
								}
								catch (error) {
									"null";
								}
							%></span><span class="whitetext">],</span><span class="graytext"> // <details class="graytext"><summary><span>which actions are available to robots in this arena?</span></summary><ul><%
								var outputList = '<li><span class="greentext">power</span>: increment the robot\'s power number</li>\
									<li><span class="greentext">take</span>: the taker with the most power wins the round\'s cubes</li>\
									<li><span class="greentext">sleep</span>: do nothing; this is the default for code errors or taking without power</li>';
								if ((session.human !== null) && (session.human.email !== null) && (((session.human.statistics.wins * 5) + session.human.statistics.losses) >= 25)) {
									outputList += '<li><span class="greentext">sap</span>: steal power from charging opponents with greater power</li>\
									<li><span class="greentext">halftake</span>: use half power, rounding up, to take cubes</li>\
									<li><span class="greentext">fliptake</span>: take the cubes but invert the colors</li>';
								}
								if ((session.human !== null) && (session.human.email !== null) && (((session.human.statistics.wins * 5) + session.human.statistics.losses) >= 50)) {
									outputList += '<li><span class="greentext">burn</span>: convert a random cube into power</li>\
									<li><span class="greentext">shock</span>: use half power to put opponents with more total cubes to sleep</li>\
									<li><span class="greentext">swaptake</span>: use half power to take cubes and return the same number of cubes, randomly</li>';
								}
								outputList
							%></ul></details></span><br>
							<span class="whitetext">tieBreaker: </span><span class="yellowtext">"<% data.rules.robots.tieBreaker || "null" %>"</span><span class="graytext"> // <details class="graytext"><summary><span>when multiple takers have the same power, where do the cubes go?</span></summary><li><span class="yellowtext">leave</span>: the cubes stay in the arena</li><li><span class="yellowtext">dissolve</span>: the cubes are destroyed</li><li><span class="yellowtext">cascade</span>: the cubes go to the next-most-powered robot</li><li><span class="yellowtext">catchup</span>: the cubes go to the robot with the least cubes</li><li><span class="yellowtext">random</span>: the cubes go to a random robot</li></details></span>
						</div>
						<span class="whitetext">},</span>
					</div>
					<div class="section" id="rules_victory">
						<span class="whitetext">victory: {</span>
						<div class="indented">
							<span class="whitetext">conditions: [</span><span class="whitetext"><% 
								try {
									var string = "";
									for (var i = 0; i < data.rules.victory.conditions.length; i++) {
										string += ("<span class='yellowtext'>\"" + data.rules.victory.conditions[i] + "\"</span>, ");
									}
									string.substring(0, string.length - 2);
								}
								catch (error) {
									"null";
								}
							%></span><span class="whitetext">],</span><span class="graytext"> // <details class="graytext"><summary><span>which cube combinations result in victory?</span></summary><li><span class="yellowtext">1of6</span>: 1 cube of each of the 6 colors</li><li><span class="yellowtext">2of3</span>: 2 cubes of each primary (red, yellow, blue) or secondary (orange, green, purple) color</li><li><span class="yellowtext">3of2</span>: 3 of each of two complimentary colors (red/green, orange/blue, yellow/purple)</li><li><span class="yellowtext">6of1</span>: 6 cubes of 1 color</li></details></span><br>
							<span class="whitetext">multiplier: </span><span class="purpletext"><% String(data.rules.victory.multiplier) || "null" %></span><span class="whitetext">,</span><span class="graytext"> // <details class="graytext"><summary><span>by how much are the cube counts necessary for victory multiplied?</span></summary></details></span><br>
							<span class="whitetext">tieBreaker: </span><span class="yellowtext">"<% data.rules.victory.tieBreaker || "null" %>"</span><span class="graytext"> // <details class="graytext"><summary><span>if multiple robots meet the victory conditions, which robot is the winner?</span></summary><li><span class="yellowtext">tie</span>: each of these robots wins</li><li><span class="yellowtext">greedy</span>: the robot with the most cubes wins</li><li><span class="yellowtext">efficient</span>: the robot with the least cubes wins</li><li><span class="yellowtext">random</span>: a random one of these robots wins</li></details></span>
						</div>
						<span class="whitetext">}</span>
					</div>
				</div>
				<div class="bracketer_bottom"><span class="whitetext">}</span></div>
			</div>
		</div>
	</body>
</html>